// ============================================
// PRISMA SCHEMA - WMS (Warehouse Management System)
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  MANAGER
  WAREHOUSE
}

enum DocumentType {
  PZ
  WZ
  MM
  INV_ADJ
}

enum DocumentStatus {
  DRAFT
  CONFIRMED
  CANCELLED
}

enum LocationStatus {
  ACTIVE
  BLOCKED
  COUNTING
}

enum InventoryStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum InventoryIntroStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProductSource {
  IMPORT
  INVENTORY_INTRO
  MANUAL
}

enum AuditAction {
  STOCK_IN
  STOCK_OUT
  STOCK_MOVE
  STOCK_ADJ
  DOC_CREATE
  DOC_CONFIRM
  DOC_CANCEL
  INV_START
  INV_COMPLETE
  INV_CANCEL
  INV_LINE
  CONTAINER_CREATE
  CONTAINER_MOVE
  CONTAINER_UPDATE
  CONTAINER_DELETE
  USER_LOGIN
  USER_LOGOUT
  USER_CREATE
  USER_UPDATE
  PRODUCT_CREATE
  PRODUCT_UPDATE
  LOCATION_CREATE
  LOCATION_UPDATE
  WAREHOUSE_CREATE
  WAREHOUSE_UPDATE
}

// ============================================
// USER MODEL
// ============================================

model User {
  id              String    @id @default(uuid())
  username        String    @unique // Login (np. "Iwona", "Admin")
  phone           String?   // Opcjonalne
  password        String
  name            String
  role            Role      @default(WAREHOUSE)
  permissions     String[]  @default([])
  isActive        Boolean   @default(true)
  lastLogin       DateTime?
  failedLogins    Int       @default(0)
  lockedUntil     DateTime?
  mustChangePw    Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  createdDocuments       Document[]       @relation("DocumentCreatedBy")
  confirmedDocuments     Document[]       @relation("DocumentConfirmedBy")
  scannedLines           DocumentLine[]   @relation("LineScannedBy")
  auditLogs              AuditLog[]
  createdInventories     InventoryCount[] @relation("InventoryCreatedBy")
  countedInventoryLines  InventoryLine[]  @relation("InventoryLineCounted")
  createdInventoryIntros InventoryIntro[] @relation("InventoryIntroCreatedBy")
  createdInventoryIntroLines InventoryIntroLine[] @relation("InventoryIntroLineCreatedBy")
  updatedInventoryIntroLines InventoryIntroLine[] @relation("InventoryIntroLineUpdatedBy")

  // Przypisane magazyny (Admin może przypisać użytkownika do magazynów)
  assignedWarehouses     UserWarehouse[]

  @@index([username])
  @@index([role])
}

// ============================================
// WAREHOUSE MODEL
// ============================================

model Warehouse {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  address   String?
  isActive  Boolean  @default(true)
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locations        Location[]
  documents        Document[]
  inventories      InventoryCount[]
  inventoryIntros  InventoryIntro[]

  // Przypisani użytkownicy
  assignedUsers    UserWarehouse[]

  @@index([code])
}

// ============================================
// USER-WAREHOUSE JUNCTION (Przypisanie użytkowników do magazynów)
// ============================================

model UserWarehouse {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  assignedAt  DateTime  @default(now())

  @@unique([userId, warehouseId])
  @@index([userId])
  @@index([warehouseId])
}

// ============================================
// LOCATION MODEL
// ============================================

model Location {
  id          String         @id @default(uuid())
  barcode     String         @unique
  warehouseId String
  warehouse   Warehouse      @relation(fields: [warehouseId], references: [id])
  rack        String
  shelf       String
  level       String
  zone        String?
  status      LocationStatus @default(ACTIVE)
  blockReason String?
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  stocks            Stock[]
  containers        Container[]
  documentLinesFrom DocumentLine[]  @relation("LineFromLocation")
  documentLinesTo   DocumentLine[]  @relation("LineToLocation")
  inventoryLines    InventoryLine[]

  @@unique([warehouseId, rack, shelf, level])
  @@index([barcode])
  @@index([warehouseId])
  @@index([status])
}

// ============================================
// PRODUCT MODEL
// ============================================

model Product {
  id          String        @id @default(uuid())
  sku         String        @unique
  ean         String        // EAN/kod kreskowy - wymagany
  name        String
  description String?       // Opis produktu
  unit        String        @default("szt")
  zone        String?       // Magazyn (grh, wodna)
  category    String?       // Rodzaj (towar, usługa)
  owner       String?
  imageUrl    String?
  priceNetto  Decimal?      @db.Decimal(10, 2) // Cena detaliczna netto
  priceBrutto Decimal?      @db.Decimal(10, 2) // Cena detaliczna brutto
  vatRate     Int?          // Stawka VAT (23, 8, 5, 0)
  source      ProductSource @default(IMPORT)   // Źródło produktu
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  stocks              Stock[]
  documentLines       DocumentLine[]
  inventoryLines      InventoryLine[]
  inventoryIntroLines InventoryIntroLine[]
  auditLogs           AuditLog[]

  @@index([sku])
  @@index([ean])
  @@index([name])
  @@index([category])
}

// ============================================
// CONTAINER MODEL (KUWETA/KARTON)
// ============================================

model Container {
  id          String    @id @default(uuid())
  barcode     String    @unique // K000001, K000002...
  name        String?
  locationId  String?
  location    Location? @relation(fields: [locationId], references: [id])
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  stocks Stock[]

  @@index([barcode])
  @@index([locationId])
}

// ============================================
// STOCK MODEL
// ============================================

model Stock {
  id          String     @id @default(uuid())
  productId   String
  product     Product    @relation(fields: [productId], references: [id])
  locationId  String
  location    Location   @relation(fields: [locationId], references: [id])
  containerId String?
  container   Container? @relation(fields: [containerId], references: [id])
  qty         Int        @default(0)
  updatedAt   DateTime   @updatedAt

  @@unique([productId, locationId, containerId])
  @@index([productId])
  @@index([locationId])
  @@index([containerId])
  @@index([qty])
}

// ============================================
// DOCUMENT MODEL
// ============================================

model Document {
  id            String         @id @default(uuid())
  number        String         @unique
  type          DocumentType
  status        DocumentStatus @default(DRAFT)
  warehouseId   String
  warehouse     Warehouse      @relation(fields: [warehouseId], references: [id])
  referenceNo   String?
  notes         String?
  internalNotes String?
  createdById   String
  createdBy     User           @relation("DocumentCreatedBy", fields: [createdById], references: [id])
  confirmedById String?
  confirmedBy   User?          @relation("DocumentConfirmedBy", fields: [confirmedById], references: [id])
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  confirmedAt   DateTime?

  lines     DocumentLine[]
  auditLogs AuditLog[]

  @@index([type, status])
  @@index([warehouseId])
  @@index([createdById])
  @@index([createdAt])
}

// ============================================
// DOCUMENT LINE MODEL
// ============================================

model DocumentLine {
  id              String    @id @default(uuid())
  documentId      String
  document        Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  productId       String
  product         Product   @relation(fields: [productId], references: [id])
  fromLocationId  String?
  fromLocation    Location? @relation("LineFromLocation", fields: [fromLocationId], references: [id])
  toLocationId    String?
  toLocation      Location? @relation("LineToLocation", fields: [toLocationId], references: [id])
  qty             Int       @default(1)
  scannedByUserId String
  scannedBy       User      @relation("LineScannedBy", fields: [scannedByUserId], references: [id])
  scannedAt       DateTime  @default(now())

  @@index([documentId])
  @@index([productId])
}

// ============================================
// INVENTORY COUNT MODEL
// ============================================

model InventoryCount {
  id           String          @id @default(uuid())
  name         String
  warehouseId  String
  warehouse    Warehouse       @relation(fields: [warehouseId], references: [id])
  status       InventoryStatus @default(IN_PROGRESS)
  createdById  String
  createdBy    User            @relation("InventoryCreatedBy", fields: [createdById], references: [id])
  createdAt    DateTime        @default(now())
  completedAt  DateTime?
  updatedAt    DateTime        @updatedAt

  lines InventoryLine[]

  @@index([warehouseId])
  @@index([status])
}

// ============================================
// INVENTORY LINE MODEL
// ============================================

model InventoryLine {
  id               String         @id @default(uuid())
  inventoryCountId String
  inventoryCount   InventoryCount @relation(fields: [inventoryCountId], references: [id], onDelete: Cascade)
  locationId       String
  location         Location       @relation(fields: [locationId], references: [id])
  productId        String
  product          Product        @relation(fields: [productId], references: [id])
  systemQty        Int            @default(0)
  countedQty       Int
  countedByUserId  String
  countedBy        User           @relation("InventoryLineCounted", fields: [countedByUserId], references: [id])
  countedAt        DateTime       @default(now())

  @@unique([inventoryCountId, locationId, productId])
  @@index([inventoryCountId])
  @@index([locationId])
}

// ============================================
// AUDIT LOG MODEL
// ============================================

model AuditLog {
  id             String      @id @default(uuid())
  userId         String
  user           User        @relation(fields: [userId], references: [id])
  action         AuditAction
  productId      String?
  product        Product?    @relation(fields: [productId], references: [id])
  fromLocationId String?
  toLocationId   String?
  qty            Int?
  documentId     String?
  document       Document?   @relation(fields: [documentId], references: [id])
  inventoryId    String?
  reason         String?
  metadata       Json?
  createdAt      DateTime    @default(now())

  @@index([userId])
  @@index([action])
  @@index([productId])
  @@index([documentId])
  @@index([createdAt])
}

// ============================================
// INVENTORY INTRO MODEL (Inwentaryzacja Wprowadzająca)
// ============================================

model InventoryIntro {
  id                     String               @id @default(uuid())
  number                 String               @unique // INV-INTRO-001
  name                   String
  status                 InventoryIntroStatus @default(IN_PROGRESS)

  warehouseId            String
  warehouse              Warehouse            @relation(fields: [warehouseId], references: [id])

  defaultLocationBarcode String               // TAR-KWIACIARNIA-01

  createdById            String
  createdBy              User                 @relation("InventoryIntroCreatedBy", fields: [createdById], references: [id])

  lines                  InventoryIntroLine[]

  createdAt              DateTime             @default(now())
  completedAt            DateTime?
  updatedAt              DateTime             @updatedAt

  @@index([warehouseId])
  @@index([status])
}

// ============================================
// INVENTORY INTRO LINE MODEL
// ============================================

model InventoryIntroLine {
  id               String         @id @default(uuid())

  inventoryIntroId String
  inventoryIntro   InventoryIntro @relation(fields: [inventoryIntroId], references: [id], onDelete: Cascade)

  // Po zakończeniu - połączenie z produktem
  productId        String?
  product          Product?       @relation(fields: [productId], references: [id])

  // Dane wprowadzone przez użytkownika
  imageUrl         String         // WYMAGANE
  priceBrutto      Decimal        @db.Decimal(10, 2) // WYMAGANE
  quantity         Int            @default(1)
  unit             String         @default("szt") // szt, kg, opak
  ean              String?        // opcjonalne
  vatRate          Int            @default(23) // Stawka VAT: 8 lub 23
  divider          Decimal        @default(2) @db.Decimal(4, 2) // Podzielnik marży (1.5, 2, 2.5, 3)

  // Auto-generowane
  tempSku          String         // INV-20251227-0001
  tempName         String         // Produkt-0001

  // Kto dodał i kiedy
  createdById      String?
  createdBy        User?          @relation("InventoryIntroLineCreatedBy", fields: [createdById], references: [id])
  createdAt        DateTime       @default(now())

  // Kto edytował i kiedy
  updatedById      String?
  updatedBy        User?          @relation("InventoryIntroLineUpdatedBy", fields: [updatedById], references: [id])
  updatedAt        DateTime?

  @@index([inventoryIntroId])
  @@index([createdById])
  @@index([updatedById])
}

// ============================================
// SETTINGS MODEL
// ============================================

model Settings {
  id          String   @id @default("main")
  companyName String?
  companyLogo String?
  data        Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
